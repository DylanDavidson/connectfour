// Generated by CoffeeScript 1.10.0
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.timeout = function(time, method) {
    return setTimeout(method, time);
  };

  this.game = null;

  this.onload = function() {
    this.game = new Game();
    return this.render();
  };

  this.render = function() {
    this.game.render();
    return requestAnimationFrame(window.render);
  };

  this.Game = (function() {
    Game.prototype.column_heights = [0, 0, 0, 0, 0, 0, 0];

    Game.prototype.pieces = [];

    function Game() {
      this.onmessage = bind(this.onmessage, this);
      this.base = new Base();
      this.menu = new Menu(this);
      this.floor = new Box(this, 100, 100, 10);
      this.board = new Board(this);
      this.setupPlaceholderPieces();
      this.worker = new Worker('./build/ai.js');
      this.worker.onmessage = this.onmessage;
      this.score = new Score(this);
    }

    Game.prototype.start = function() {
      return this.controller = new Controller(this);
    };

    Game.prototype.reset = function() {
      var j, len, piece, ref;
      this.column_heights = [0, 0, 0, 0, 0, 0, 0];
      this.score = new Score(this);
      ref = this.pieces;
      for (j = 0, len = ref.length; j < len; j++) {
        piece = ref[j];
        this.base.removeFromScene(piece.object);
      }
      return this.pieces = [];
    };

    Game.prototype.setupPlaceholderPieces = function() {
      var i, j, piece, results;
      this.placeholders = [];
      results = [];
      for (i = j = 0; j <= 6; i = ++j) {
        piece = new Piece(this);
        piece.stop();
        piece.setColor(0xecf0f1);
        piece.setOpacity(0.3);
        piece.setPosition(this.board.COLUMNS[i], 0, 75);
        piece.setName('Placeholder');
        results.push(this.placeholders.push(piece));
      }
      return results;
    };

    Game.prototype.win = function(playerWins) {
      var element, text;
      this.controller.reset();
      this.controller = null;
      text = playerWins ? 'You Win' : 'AI Wins';
      element = document.getElementById('win');
      element.innerHTML = text;
      element.style.opacity = 1;
      element.style.visibility = "visible";
      return this.menu.showResetMenu();
    };

    Game.prototype.place = function(column) {
      var piece, result, row;
      this.column = null;
      piece = new Piece(this, this.controller.isPlayerTurn());
      row = this.column_heights[column]++;
      this.score.place(row, column, this.controller.isPlayerTurn());
      piece.place(row, column);
      this.pieces.push(piece);
      result = this.score.checkForWin();
      if (result || result === false) {
        return this.win(result);
      }
    };

    Game.prototype.highlight = function(column) {
      this.placeholders[column].setColor(0xe74c3c);
      return timeout(600, (function(_this) {
        return function() {
          return _this.placeholders[column].setColor(0xecf0f1);
        };
      })(this));
    };

    Game.prototype.moveAI = function() {
      return this.worker.postMessage('move');
    };

    Game.prototype.onmessage = function(message) {
      if (!this.controller) {
        return;
      }
      return timeout(1500, (function(_this) {
        return function() {
          _this.place(message.data);
          return timeout(750, function() {
            return _this.controller.setPlayerTurn(true);
          });
        };
      })(this));
    };

    Game.prototype.render = function() {
      if (this.controller) {
        this.controller.update();
      }
      return this.base.render();
    };

    Game.prototype.addToScene = function(object) {
      return this.base.addToScene(object);
    };

    Game.prototype.removeFromScene = function(object) {
      return this.base.removeFromScene(object);
    };

    return Game;

  })();

}).call(this);
